sudo: required

services:
    - docker

# This is just shere for Travis CI to report correctly
language: go
go:
    - "1.10"

# go_import_path: github.com/clearlinux/clr-installer

before_install:
    - docker pull clearlinux
    - docker run --network=host --name clear-test -v $(pwd):/travis -v /dev:/dev  -v /var/tmp/test:/tmp -v /sys/fs/cgroup:/sys/fs/cgroup:ro -e container=docker --privileged --tmpfs /run --tmpfs /run/lock -dit --rm clearlinux:latest /sbin/init
    - docker ps

# we need both -l (login) and -c (command) for the bash shell
# in order to ensure we read the .profile settings
install:
    - docker exec -it clear-test bash -lc "swupd info"
    - docker exec -it clear-test bash -lc "swupd update"
    - docker exec -it clear-test bash -lc "swupd bundle-add sysadmin-basic storage-utils network-basic go-basic-dev git telemetrics"
    - docker exec -it clear-test bash -lc "echo export GOPATH=\$(go env GOPATH) >> \${HOME}/.profile"
    - docker exec -it clear-test bash -lc "echo export PATH=\\\${PATH}:\\\${GOPATH}/bin >> \${HOME}/.profile"
    - docker exec -it clear-test bash -lc "go get -u gopkg.in/alecthomas/gometalinter.v2"
    - docker exec -it clear-test bash -lc "gometalinter.v2 --install"

before_script:
    - docker exec -it clear-test bash -lc "ls -l /var/spool/"
      # Debug information
    - docker exec -it clear-test bash -lc "set;printenv"
    - docker exec -it clear-test bash -lc "telemctl restart"
      # Debug information
    - docker exec -it clear-test bash -lc "journalctl|cat"
      # Dump more network related information
    - docker exec -it clear-test bash -lc "netstat -rn"
    - docker exec -it clear-test bash -lc "ip a"

script:
    - docker exec -it clear-test bash -lc "cd /travis ; make dist-clean"
    - docker exec -it clear-test bash -lc "cd /travis ; make"
    - docker exec -it clear-test bash -lc "cd /travis ; make lint"
    - travis_retry docker exec -it clear-test bash -lc "cd /travis ; make check"

after_script:
    - docker container stop clear-test
